@page "/qrguard"

@using System;
@using System.Text.Json
@using System.Text.Json.Serialization
@using System.Net;
@using System.IO;
@inject IHttpClientFactory ClientFactory


<PageTitle>QRGuard</PageTitle>

<h1>QRGuard</h1>

<p>
    @if(string.IsNullOrWhiteSpace(name)){
        <div>请输入身份识别码：</div>
    }
    @if(!requested){
        <input @bind="name" @bind:event="oninput"/>
    }
</p>


@if(requested) {
<div align="center">
    <h2>@name</h2>
    <a href = "@qrcodePath">
    <img src="@qrcodePath" alt="QRCode" width=280 height=280/>
    </a>
    <p>@DateTime.Now</p>
    <button class="btn btn-primary" @onclick="qrCodeReq">ReFresh QRCode</button>
</div>
}else{
    <h2>@name</h2>
    <button class="btn btn-primary" @onclick="qrCodeReq">ReFresh QRCode</button>
}


@code {
    private string? name;

    private string? qrcodePath = null;

    private bool requested = false;

    private void qrCodeReq() {
        if(string.IsNullOrWhiteSpace(name))return;
        requested = false;
        WriteBytesToFile($"./wwwroot/qrcode/{name}.jpg",GetBytesFromUrl($"http://localhost:11451/api/QRGuard/{name}/code"));
        qrcodePath = $"qrcode/{name}.jpg?time=${DateTime.Now.ToFileTime()}";
        requested = true;
        
    }

    private static byte[] GetBytesFromUrl(string url)
        {
            byte[] b;
            HttpWebRequest myReq = (HttpWebRequest)WebRequest.Create(url);
            WebResponse myResp = myReq.GetResponse();

            Stream stream = myResp.GetResponseStream();
            using (BinaryReader br = new BinaryReader(stream))
            {
                b = br.ReadBytes(50000);
                br.Close();
            }
            myResp.Close();
            return b;

        }

    private static void WriteBytesToFile(string fileName, byte[] content)
        {
            FileStream fs = new FileStream(fileName, FileMode.Create);
            BinaryWriter w = new BinaryWriter(fs);
            try
            {
                w.Write(content);
            }
            finally
            {
                fs.Close();
                w.Close();
            }

        }

   
}
